`r if(knitr:::is_latex_output()) '\\startappendices'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'` 

```{r}
resource_version <- "20231218-195551-0129f3b4"
```

# Models for areal spatial structure

## Comparison of AGHQ to NUTS {#aghq-nuts}

```{r}
aghq_nuts_comparison_diagnostics <- readr::read_csv(paste0("resources/beyond-borders/", resource_version, "/depends/diagnostics.csv"))
```

(ref:iid-aghq-nuts) A comparison of the posterior means and standard deviations obtained with AGHQ via `aghq` as compared with NUTS via `tmbstan` fitting an IID inferential model to IID synthetic data on the grid geometry (Panel \@ref(fig:geometries)E). For NUTS, the minimum ESS was `r round(aghq_nuts_comparison_diagnostics[1, "min_ess"])`, and the maximum value of the potential scale reduction factor was `r sprintf("%.2f", aghq_nuts_comparison_diagnostics[1, "max_rhat"])`.

```{r iid-aghq-nuts, fig.cap="(ref:iid-aghq-nuts)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/iid-aghq-nuts.png")
knitr::include_graphics(path)
```

(ref:besag-aghq-nuts) A comparison of the posterior means and standard deviations obtained with AGHQ via `aghq` as compared with NUTS via `tmbstan` fitting a Besag inferential model to IID synthetic data on the grid geometry (Panel \@ref(fig:geometries)E). For NUTS, the minimum ESS was `r round(aghq_nuts_comparison_diagnostics[2, "min_ess"])`, and the maximum value of the potential scale reduction factor was `r sprintf("%.2f", aghq_nuts_comparison_diagnostics[2, "max_rhat"])`.

```{r besag-aghq-nuts, fig.cap="(ref:besag-aghq-nuts)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/besag-aghq-nuts.png")
knitr::include_graphics(path)
```

(ref:bym2-aghq-nuts) A comparison of the posterior means and standard deviations obtained with AGHQ via `aghq` as compared with NUTS via `tmbstan` fitting a BYM2 inferential model to IID synthetic data on the grid geometry (Panel \@ref(fig:geometries)E). For NUTS, the minimum ESS was `r round(aghq_nuts_comparison_diagnostics[3, "min_ess"])`, and the maximum value of the potential scale reduction factor was `r sprintf("%.2f", aghq_nuts_comparison_diagnostics[3, "max_rhat"])`.

```{r bym2-aghq-nuts, fig.cap="(ref:bym2-aghq-nuts)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/bym2-aghq-nuts.png")
knitr::include_graphics(path)
```

(ref:fck-aghq-nuts) A comparison of the posterior means and standard deviations obtained with AGHQ via `aghq` as compared with NUTS via `tmbstan` fitting a FCK inferential model to IID synthetic data on the grid geometry (Panel \@ref(fig:geometries)E). For NUTS, the minimum ESS was `r round(aghq_nuts_comparison_diagnostics[4, "min_ess"])`, and the maximum value of the potential scale reduction factor was `r sprintf("%.2f", aghq_nuts_comparison_diagnostics[4, "max_rhat"])`.

```{r fck-aghq-nuts, fig.cap="(ref:fck-aghq-nuts)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/fck-aghq-nuts.png")
knitr::include_graphics(path)
```

(ref:time-taken) A comparison of time taken to fit AGHQ via `aghq` as compared with NUTS via `tmbstan` for each inferential model.

```{r time-taken, fig.cap="(ref:time-taken)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/time-taken.png")
knitr::include_graphics(path)
```

## Lengthscale prior sensitivity {#lengthscale-prior}

| Description | Prior | Additional details  |
|:------------|:------|:--------------------|
| Gamma | $l \sim \text{Gamma}(1, 1)$ ||
| Geometry-informed inverse-gamma | $l \sim \text{IG}(a, b)$ | The parameters $a$ and $b$ chosen such that 1\% of the prior mass was below 0.1 and 1\% of the prior mass was above the maximum distance between points [@betancourt2017robust] |
| Geometry-informed normal | $l \sim \mathcal{N}^{+}(0, \sigma)$ | The parameter $\sigma$ set as one third the difference between the minimum and maximum distance between points [@betancourt2017robust] |
| Log-normal | $l \sim \text{Log-normal}(0, 1)$ | |
| Non-informative | $p(l) = 1$ | This is an improper prior in that it does not integrate to one |
| Oracle normal | $l \sim \mathcal{N}^{+}(2.5, 1)$ | The mean of this prior was set to the true value of the lengthscale |

Table: (\#tab:lengthscale-prior) Six lengthscale prior distributions were considered for use.

(ref:lengthscale-prior) The density for each lengthscale prior distributions as given in Table \@ref(tab:lengthscale-prior).

```{r lengthscale-prior, fig.cap="(ref:lengthscale-prior)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/lengthscale-prior.png")
knitr::include_graphics(path)
```

(ref:lengthscale-posterior) Lengthscale posterior distributions obtained using NUTS to fit a centroid kernel model to integrated kernel data grid on geometry (Panel \@ref(fig:geometries)E), with six different lengthscale prior distributions as given in Table \@ref(tab:lengthscale-prior).

```{r lengthscale-posterior, fig.cap="(ref:lengthscale-posterior)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/lengthscale-posterior.png")
knitr::include_graphics(path)
```

## Simulation study {#simulation-appendix}

### Lengthscale hyperparameter recovery {#lengthscale}

(ref:lengthscale-recovery) The lengthscale posterior mean and 95% credible interval obtained using the centroid kernel model on integrated kernel data for the first 40 simulation replicates on each geometry. The true lengthscale, and lengthscale obtained using the heuristic method of @best1999bayesian are shown as dashed lines.

```{r lengthscale-recovery, fig.cap="(ref:lengthscale-recovery)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/lengthscale-recovery.png")
knitr::include_graphics(path)
```

### BYM2 proportion hyperparameter {#bym2-proportion}

(ref:proportion-recovery) Figure caption.

```{r proportion-recovery, fig.cap="(ref:proportion-recovery)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/proportion-recovery.png")
knitr::include_graphics(path)
```

### Mean squared error

```{r mse-table}
gt_mse <- readRDS(paste0("resources/beyond-borders/", resource_version, "/depends/gt_mse.rds"))

gt_mse <- gt_mse %>%
  gt::tab_caption(caption = "The average mean squared error (MSE) of each inferential model, under different simulation and geometry settings.")

if(knitr::is_html_output()) gt_mse
if(knitr::is_latex_output()) gt::as_latex(gt_mse)
```

### Continuous ranked probability score

```{r crps-table}
gt_crps <- readRDS(paste0("resources/beyond-borders/", resource_version, "/depends/gt_crps.rds"))

gt_crps <- gt_crps %>%
  gt::tab_caption(caption = "The average continuous ranked probability score (CRPS) of each inferential model, under different simulation and geometry settings.")

if(knitr::is_html_output()) gt_crps
if(knitr::is_latex_output()) gt::as_latex(gt_crps)
```

(ref:crps-mean-se-1) The mean CRPS with 95% credible interval (generated using 1.96 times the standard error) in estimating $\rho$ using each inferential model and simulation model on the first vignette geometry (Panel \@ref(fig:geometries)A).

```{r crps-mean-se-1, fig.cap="(ref:crps-mean-se-1)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/crps-mean-se-1.png")
knitr::include_graphics(path)
```

(ref:crps-mean-se-2) The mean CRPS with 95% credible interval (generated using 1.96 times the standard error) in estimating $\rho$ using each inferential model and simulation model on the second vignette geometry (Panel \@ref(fig:geometries)B).

```{r crps-mean-se-2, fig.cap="(ref:crps-mean-se-2)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/crps-mean-se-2.png")
knitr::include_graphics(path)
```

(ref:crps-mean-se-3) The mean CRPS with 95% credible interval (generated using 1.96 times the standard error) in estimating $\rho$ using each inferential model and simulation model on third vignette geometry (Panel \@ref(fig:geometries)C).

```{r crps-mean-se-3, fig.cap="(ref:crps-mean-se-3)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/crps-mean-se-3.png")
knitr::include_graphics(path)
```

(ref:crps-mean-se-4) The mean CRPS with 95% credible interval (generated using 1.96 times the standard error) in estimating $\rho$ using each inferential model and simulation model on the fourth vignette geometry (Panel \@ref(fig:geometries)D).

```{r crps-mean-se-4, fig.cap="(ref:crps-mean-se-4)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/crps-mean-se-4.png")
knitr::include_graphics(path)
```

(ref:map-crps-1) Cloropleths showing the mean value of the CRPS in estimating $\rho$, under each inferential model and simulation model, at each area of the first vignette geometry (Panel \@ref(fig:geometries)A).

```{r map-crps-1, fig.cap="(ref:map-crps-1)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/map-crps-1.png")
knitr::include_graphics(path)
```

(ref:map-crps-2) Cloropleths showing the mean value of the CRPS in estimating $\rho$, under each inferential model and simulation model, at each area of the second vignette geometry (Panel \@ref(fig:geometries)B).

```{r map-crps-2, fig.cap="(ref:map-crps-2)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/map-crps-2.png")
knitr::include_graphics(path)
```

(ref:map-crps-3) Cloropleths showing the mean value of the CRPS in estimating $\rho$, under each inferential model and simulation model, at each area of the third vignette geometry (Panel \@ref(fig:geometries)C).

```{r map-crps-3, fig.cap="(ref:map-crps-3)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/map-crps-3.png")
knitr::include_graphics(path)
```

(ref:map-crps-4) Cloropleths showing the mean value of the CRPS in estimating $\rho$, under each inferential model and simulation model, at each area of the fourth vignette geometry (Panel \@ref(fig:geometries)D).

```{r map-crps-4, fig.cap="(ref:map-crps-4)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/map-crps-4.png")
knitr::include_graphics(path)
```

(ref:map-crps-grid) Cloropleths showing the mean value of the CRPS in estimating $\rho$, under each inferential model and simulation model, at each area of the grid geometry (Panel \@ref(fig:geometries)E).

```{r map-crps-grid, fig.cap="(ref:map-crps-grid)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/map-crps-grid.png")
knitr::include_graphics(path)
```

(ref:map-crps-civ) Cloropleths showing the mean value of the CRPS in estimating $\rho$, under each inferential model and simulation model, at each area of the Côte d’Ivoire geometry (Panel \@ref(fig:geometries)F).

```{r map-crps-civ, fig.cap="(ref:map-crps-civ)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/map-crps-civ.png")
knitr::include_graphics(path)
```

(ref:map-crps-tex) Cloropleths showing the mean value of the CRPS in estimating $\rho$, under each inferential model and simulation model, at each area of the Texas geometry (Panel \@ref(fig:geometries)G).

```{r map-crps-tex, fig.cap="(ref:map-crps-tex)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/map-crps-tex.png")
knitr::include_graphics(path)
```

### Calibration

(ref:histogram-ecdf-diff-1) Probability integral transform histograms and empirical cumulative distribution function difference plots for $\rho$, under each inferential model and simulation model, for the first vignette geometry (Panel \@ref(fig:geometries)A).

```{r histogram-ecdf-diff-1, fig.cap="(ref:histogram-ecdf-diff-1)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-1.png")
knitr::include_graphics(path)
```

(ref:histogram-ecdf-diff-2) Probability integral transform histograms and empirical cumulative distribution function difference plots for $\rho$, under each inferential model and simulation model, for the second vignette geometry (Panel \@ref(fig:geometries)B).

```{r histogram-ecdf-diff-2, fig.cap="(ref:histogram-ecdf-diff-2)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-2.png")
knitr::include_graphics(path)
```

(ref:histogram-ecdf-diff-3) Probability integral transform histograms and empirical cumulative distribution function difference plots for $\rho$, under each inferential model and simulation model, for the third vignette geometry (Panel \@ref(fig:geometries)C).

```{r histogram-ecdf-diff-3, fig.cap="(ref:histogram-ecdf-diff-3)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-3.png")
knitr::include_graphics(path)
```

(ref:histogram-ecdf-diff-4) Probability integral transform histograms and empirical cumulative distribution function difference plots for $\rho$, under each inferential model and simulation model, for the fourth vignette geometry (Panel \@ref(fig:geometries)D).

```{r histogram-ecdf-diff-4, fig.cap="(ref:histogram-ecdf-diff-4)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-4.png")
knitr::include_graphics(path)
```

(ref:histogram-ecdf-diff-grid) Probability integral transform histograms and empirical cumulative distribution function difference plots for $\rho$, under each inferential model and simulation model, for the grid geometry (Panel \@ref(fig:geometries)E).

```{r histogram-ecdf-diff-grid, fig.cap="(ref:histogram-ecdf-diff-grid)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-grid.png")
knitr::include_graphics(path)
```

(ref:histogram-ecdf-diff-civ) Probability integral transform histograms and empirical cumulative distribution function difference plots for $\rho$, under each inferential model and simulation model, for the Côte d’Ivoire geometry (Panel \@ref(fig:geometries)F).

```{r histogram-ecdf-diff-civ, fig.cap="(ref:histogram-ecdf-diff-civ)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-civ.png")
knitr::include_graphics(path)
```

(ref:histogram-ecdf-diff-tex) Probability integral transform histograms and empirical cumulative distribution function difference plots for $\rho$, under each inferential model and simulation model, for the Texas geometry (Panel \@ref(fig:geometries)G).

```{r histogram-ecdf-diff-tex, fig.cap="(ref:histogram-ecdf-diff-tex)"}
path <- paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-tex.png")
knitr::include_graphics(path)
```

## HIV study {#hiv-appendix}

### Estimates

(ref:ladder-civ2017phia) The HIV prevalence posterior mean and 95% credible interval for each area of Côte d’Ivoire, based on the 2017 PHIA survey. Direct estimates obtained from the survey are as shown in Panel \@ref(fig:hiv-surveys)A.

```{r ladder-civ2017phia, fig.cap="(ref:ladder-civ2017phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/ladder-civ2017phia.png"))
```

(ref:ladder-mwi2016phia) The HIV prevalence posterior mean and 95% credible interval for each area of Malawi, based on the 2016 PHIA survey. Direct estimates obtained from the survey are as shown in Panel \@ref(fig:hiv-surveys)B.

```{r ladder-mwi2016phia, fig.cap="(ref:ladder-mwi2016phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/ladder-mwi2016phia.png"))
```

(ref:ladder-tza2017phia) The HIV prevalence posterior mean and 95% credible interval for each area of Tanzania, based on the 2017 PHIA survey. Direct estimates obtained from the survey are as shown in Panel \@ref(fig:hiv-surveys)C.

```{r ladder-tza2017phia, fig.cap="(ref:ladder-tza2017phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/ladder-tza2017phia.png"))
```

(ref:ladder-zwe2016phia) The HIV prevalence posterior mean and 95% credible interval for each area of Zimbabwe, based on the 2016 PHIA survey. Direct estimates obtained from the survey are as shown in Panel \@ref(fig:hiv-surveys)D.

```{r ladder-zwe2016phia, fig.cap="(ref:ladder-zwe2016phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/ladder-zwe2016phia.png"))
```

### Cross-validation

#### Mean squared error

```{r cv-mse}
gt_cv_mse <- readRDS(paste0("resources/beyond-borders/", resource_version, "/depends/gt_cv-mse.rds"))

gt_cv_mse <- gt_cv_mse %>%
  gt::tab_caption(caption = 'The mean pointwise leave-one-out and spatial leave-one-out MSE, with standard errors, for each inferential model across the four considered PHIA surveys. The units used in this table around thousandths.')

if(knitr::is_html_output()) {
  gt_cv_mse
}

if(knitr::is_latex_output()) {
  gt_cv_mse %>%
    gt::as_latex()
}
```

#### Continuous ranked probability score

(ref:crps-mean-se-civ2017phia) The pointwise CRPS for $\rho_i$ using either leave-one-out or spatial leave-one-out cross-validation, with mean and 95% credible interval for the Côte d’Ivoire 2017 PHIA survey (Panel \@ref(fig:hiv-surveys)A).

```{r crps-mean-se-civ2017phia, fig.cap="(ref:crps-mean-se-civ2017phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/crps-mean-se-civ2017phia.png"))
```

(ref:crps-mean-se-mwi2016phia) The pointwise CRPS for $\rho_i$ using either leave-one-out or spatial leave-one-out cross-validation, with mean and 95% credible interval, for the Malawi 2016 PHIA survey \@ref(fig:hiv-surveys)B.

```{r crps-mean-se-mwi2016phia, fig.cap="(ref:crps-mean-se-mwi2016phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/crps-mean-se-mwi2016phia.png"))
```

(ref:crps-mean-se-tza2017phia) The pointwise CRPS for $\rho_i$ using either leave-one-out or spatial leave-one-out cross-validation, with mean and 95% credible interval, for the Tanzania 2017 PHIA survey \@ref(fig:hiv-surveys)C.

```{r crps-mean-se-tza2017phia, fig.cap="(ref:crps-mean-se-tza2017phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/crps-mean-se-tza2017phia.png"))
```

(ref:crps-mean-se-zwe2016phia) The pointwise CRPS for $\rho_i$ using either leave-one-out or spatial leave-one-out cross-validation, with mean and 95% credible interval, for the Zimbabwe 2016 PHIA survey \@ref(fig:hiv-surveys)D.

```{r crps-mean-se-zwe2016phia, fig.cap="(ref:crps-mean-se-zwe2016phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/crps-mean-se-zwe2016phia.png"))
```

(ref:map-civ2017phia) Côte d’Ivoire 2017 PHIA survey \@ref(fig:hiv-surveys)A.

```{r map-civ2017phia, fig.cap="(ref:map-civ2017phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/map-civ2017phia.png"))
```

(ref:map-mwi2016phia) Malawi 2016 PHIA survey \@ref(fig:hiv-surveys)B.

```{r map-mwi2016phia, fig.cap="(ref:map-mwi2016phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/map-mwi2016phia.png"))
```

(ref:map-tza2017phia) Tanzania 2017 PHIA survey \@ref(fig:hiv-surveys)C.

```{r map-tza2017phia, fig.cap="(ref:map-tza2017phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/map-tza2017phia.png"))
```

(ref:map-zwe2016phia) Zimbabwe 2016 PHIA survey \@ref(fig:hiv-surveys)D.

```{r map-zwe2016phia, fig.cap="(ref:map-zwe2016phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/map-zwe2016phia.png"))
```

(ref:histogram-ecdf-diff-civ2017phia) Côte d’Ivoire 2017 PHIA survey \@ref(fig:hiv-surveys)A.

```{r histogram-ecdf-diff-civ2017phia, fig.cap="(ref:histogram-ecdf-diff-civ2017phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-civ2017phia.png"))
```

(ref:histogram-ecdf-diff-mwi2016phia) Malawi 2016 PHIA survey \@ref(fig:hiv-surveys)B.

```{r histogram-ecdf-diff-mwi2016phia, fig.cap="(ref:histogram-ecdf-diff-mwi2016phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-mwi2016phia.png"))
```

(ref:histogram-ecdf-diff-tza2017phia) Tanzania 2017 PHIA survey \@ref(fig:hiv-surveys)C.

```{r histogram-ecdf-diff-tza2017phia, fig.cap="(ref:histogram-ecdf-diff-tza2017phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-tza2017phia.png"))
```

(ref:histogram-ecdf-diff-zwe2016phia) Zimbabwe 2016 PHIA survey \@ref(fig:hiv-surveys)D.

```{r histogram-ecdf-diff-zwe2016phia, fig.cap="(ref:histogram-ecdf-diff-zwe2016phia)"}
knitr::include_graphics(paste0("resources/beyond-borders/", resource_version, "/depends/histogram-ecdf-diff-zwe2016phia.png"))
```
